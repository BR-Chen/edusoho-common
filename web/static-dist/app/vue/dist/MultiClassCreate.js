(window.webpackJsonp=window.webpackJsonp||[]).push([[388],{1401:function(e,t,a){},1417:function(e,t,a){"use strict";var i=a(1401);a.n(i).a},938:function(e,t,a){"use strict";a.r(t);var i=a(29),s=a.n(i),r=a(43),n=a.n(r),l=a(68),c=a.n(l),o=a(553),u=a(1388),d=a(1411),h={name:"MultiClassCreate",components:{AsideLayout:u.a,Schedule:d.a},data:function(){return{ajaxLoading:!1,form:this.$form.createForm(this,{name:"multi_class_create"}),selectedCourseId:0,selectedCourseSetId:0,multiClassId:0,mode:"create",course:{list:[],title:"",flag:!0,initialValue:void 0,paging:{pageSize:10,current:0}},product:{list:[],flag:!0,initialValue:void 0,paging:{pageSize:10,current:0}},teacher:{list:[],title:"",flag:!0,initialValue:void 0,paging:{pageSize:10,current:0}},assistant:{list:[],title:"",flag:!0,initialValue:[],paging:{pageSize:10,current:0}}}},computed:{breadcrumbName:function(){return{create:"新建班课",editor:"编辑班课"}[this.mode]}},created:function(){var e=this.$route.query.id;if(e)return this.multiClassId=e,this.mode="editor",void this.fetchEditorMultiClass();var t=this.$route.query.course;if(t)return t=JSON.parse(t),this.selectedCourseId=t.id,this.selectedCourseSetId=t.courseSetId,this.course.list.push(t),this.$set(this.course,"initialValue",t.id),this.fetchCourse(),this.fetchProducts(),void this.fetchCourseTeacher(t.id);this.initFetch()},methods:{initFetch:function(){this.fetchCourse(),this.fetchAssistants(),this.fetchProducts(),this.fetchTeacher()},duplicateRemoval:function(e,t){c.a.forEach(e,(function(a,i){if(a.id==t)return e.splice(i,1),!1}))},disabledTeacher:function(e){var t=e||this.form.getFieldValue("assistantIds")||this.assistant.initialValue;c.a.forEach(this.teacher.list,(function(e){c.a.includes(t,e.id)||(e.disabled=!1),c.a.forEach(t,(function(t){e.id==t&&(e.disabled=!0)}))}))},disabledAssistant:function(e){var t=e||this.form.getFieldValue("teacherId")||this.teacher.initialValue;c.a.forEach(this.assistant.list,(function(e){e.id==t?e.disabled=!0:e.disabled=!1}))},fetchCourseTeacher:function(e){var t=this;o.c.getTeacher(e,{role:"teacher"}).then((function(e){var a=e.data[0].user;t.teacher={list:[a],title:"",flag:!0,initialValue:a.id,paging:{pageSize:10,current:0}},t.form.setFieldsValue({teacherId:a.id}),t.fetchAssistants(),t.fetchTeacher()}))},fetchEditorMultiClass:function(){var e=this;o.i.get(this.multiClassId).then((function(t){var a=t.title,i=t.course,s=t.courseId,r=t.product,n=t.productId,l=t.teachers,c=t.teacherIds,o=t.assistants,u=t.assistantIds;e.form.setFieldsValue({title:a}),e.selectedCourseId=s,e.selectedCourseSetId=i.courseSetId,e.course.list=[i],e.course.initialValue=s,e.product.list=[r],e.product.initialValue=n,e.teacher.list=l,e.teacher.initialValue=c[0],e.assistant.list=o,e.assistant.initialValue=u,e.initFetch()}))},fetchCourse:function(){var e=this,t=this.course,a=t.title,i=t.paging,s=i.pageSize,r={isDefault:1,limit:s,offset:s*i.current};a&&(r.titleLike=a),o.h.get("teach_courses",{params:r}).then((function(t){e.course.paging.current++,e.course.initialValue&&e.duplicateRemoval(t.data,e.course.initialValue),e.course.list=c.a.concat(e.course.list,t.data),c.a.size(e.course.list)>=t.paging.total&&(e.course.flag=!1)}))},handleSearchCourse:c.a.debounce((function(e){this.course={list:[],title:e,flag:!0,paging:{pageSize:10,current:0}},this.fetchCourse()}),300),courseScroll:c.a.debounce((function(e){var t=e.target;t.scrollHeight-t.offsetHeight-20<t.scrollTop&&this.course.flag&&this.fetchCourse()}),300),fetchProducts:function(){var e=this,t=this.product,a=t.title,i=t.paging,s=i.pageSize,r={limit:s,offset:s*i.current};a&&(r.keywords=a),o.k.search(r).then((function(t){e.product.paging.current++,e.product.initialValue&&e.duplicateRemoval(t.data,e.product.initialValue),e.product.list=c.a.concat(e.product.list,t.data),c.a.size(e.product.list)>=t.paging.total&&(e.product.flag=!1)}))},productScroll:c.a.debounce((function(e){var t=e.target;t.scrollHeight-t.offsetHeight-20<t.scrollTop&&this.product.flag&&this.fetchProducts()}),300),handleSearchProduct:c.a.debounce((function(e){this.product={list:[],title:e,flag:!0,paging:{pageSize:10,current:0}},this.fetchProducts()}),300),fetchTeacher:function(){var e=this,t=this.teacher,a=t.title,i=t.paging,s=i.pageSize,r={limit:s,offset:s*i.current};a&&(r.nickname=a),o.n.search(r).then((function(t){e.teacher.paging.current++,e.teacher.initialValue&&e.duplicateRemoval(t.data,e.teacher.initialValue),e.teacher.list=c.a.concat(e.teacher.list,t.data),c.a.size(e.teacher.list)>=t.paging.total&&(e.teacher.flag=!1),e.disabledTeacher()}))},handleSearchTeacher:c.a.debounce((function(e){this.teacher={list:[],title:e,flag:!0,paging:{pageSize:10,current:0}},this.fetchTeacher()}),300),teacherScroll:c.a.debounce((function(e){var t=e.target;t.scrollHeight-t.offsetHeight-20<t.scrollTop&&this.teacher.flag&&this.fetchTeacher()}),300),fetchAssistants:function(){var e=this,t=this.assistant,a=t.title,i=t.paging,s=i.pageSize,r={limit:s,offset:s*i.current};a&&(r.nickname=a),o.a.search(r).then((function(t){e.assistant.paging.current++,c.a.forEach(e.assistant.initialValue,(function(a){e.duplicateRemoval(t.data,a)})),e.assistant.list=c.a.concat(e.assistant.list,t.data),c.a.size(e.assistant.list)>=t.paging.total&&(e.assistant.flag=!1),e.disabledAssistant()}))},handleSearchAssistant:c.a.debounce((function(e){this.assistant={list:[],title:e,flag:!0,paging:{pageSize:10,current:0}},this.fetchAssistants()}),300),assistantScroll:c.a.debounce((function(e){var t=e.target;t.scrollHeight-t.offsetHeight-20<t.scrollTop&&this.assistant.flag&&this.fetchAssistants()}),300),handleChangeCourse:function(e){var t=this;this.selectedCourseId=e,c.a.forEach(this.course.list,(function(a){if(a.id==e)return t.selectedCourseSetId=a.courseSetId,!1})),this.fetchCourseTeacher(e)},handleChange:function(e,t){"teacher"!==t?"assistant"===t&&this.disabledTeacher(e):this.disabledAssistant(e)},validatorTitle:function(e,t,a){var i=this;return n()(s.a.mark((function e(){var r;return s.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.q.search({type:"multiClass",title:t,exceptId:i.multiClassId});case 2:r=e.sent,r.result?a():a("班课名称不能与已创建的相同");case 5:case"end":return e.stop()}}),e)})))()},validatorTitleLength:function(e,t,a){t.replace(/[\u0391-\uFFE5]/g,"aa").length/2<=40?a():a("班课名称不能超过40个字符")},validatorAssistant:function(e,t,a){t.length>20?a("最多选择20个助教"):a()},handleSubmit:function(e){var t=this;e.preventDefault(),this.form.validateFields((function(e,a){e||("create"!==t.mode?"editor"===t.mode&&t.editorMultiClass(a):t.createMultiClass(a))}))},createMultiClass:function(e){var t=this;this.ajaxLoading=!0,o.i.add(e).then((function(){t.clickCancelCreate()})).finally((function(){t.ajaxLoading=!1}))},editorMultiClass:function(e){var t=this;this.ajaxLoading=!0,o.i.editorMultiClass(this.multiClassId,e).then((function(){t.clickCancelCreate()})).finally((function(){t.ajaxLoading=!1}))},clickCancelCreate:function(){var e={},t=this.$route.params.paging;t&&(e.paging=t),this.$router.push({name:"MultiClass",params:e})}}},f=(a(1417),a(30)),p=Object(f.a)(h,(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("aside-layout",{staticStyle:{"padding-bottom":"88px"},attrs:{breadcrumbs:[{name:e.breadcrumbName}]}},[a("a-form",{staticStyle:{"max-width":"1000px"},attrs:{form:e.form,"label-col":{span:3},"wrapper-col":{span:21}}},[a("a-form-item",{attrs:{label:"班课名称"}},[a("a-input",{directives:[{name:"decorator",rawName:"v-decorator",value:["title",{trigger:"blur",rules:[{required:!0,message:"请填写班课名称"},{validator:e.validatorTitle},{validator:e.validatorTitleLength}]}],expression:"['title', {\n          trigger: 'blur',\n          rules: [\n            { required: true, message: '请填写班课名称' },\n            { validator: validatorTitle },\n            { validator: validatorTitleLength }\n          ]\n        }]"}],attrs:{placeholder:"请输入班课名称"}})],1),e._v(" "),a("a-form-item",{attrs:{label:"选择课程"}},[a("a-row",{attrs:{gutter:16}},[a("a-col",{attrs:{span:"editor"===e.mode?24:20}},[a("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["courseId",{initialValue:e.course.initialValue,rules:[{required:!0,message:"请选择课程"}]}],expression:"['courseId', {\n              initialValue: course.initialValue,\n              rules: [\n                { required: true, message: '请选择课程' }\n              ]\n            }]"}],attrs:{"show-search":"","filter-option":!1,placeholder:"请选择课程",disabled:"editor"===e.mode},on:{popupScroll:e.courseScroll,search:e.handleSearchCourse,change:e.handleChangeCourse}},e._l(e.course.list,(function(t){return a("a-select-option",{key:t.id},[e._v("\n              "+e._s(t.courseSetTitle)+"\n            ")])})),1)],1),e._v(" "),"editor"!==e.mode?a("a-col",{attrs:{span:4}},[a("a-button",{attrs:{type:"primary",block:!0},on:{click:function(t){return e.$router.push({name:"MultiClassCreateCourse"})}}},[a("a-icon",{attrs:{type:"plus"}}),e._v("\n            创建新课程\n          ")],1)],1):e._e()],1)],1),e._v(" "),a("a-form-item",{attrs:{label:"所属产品"}},[a("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["productId",{initialValue:e.product.initialValue,rules:[{required:!0,message:"请选择归属产品"}]}],expression:"['productId', {\n          initialValue: product.initialValue,\n          rules: [\n            { required: true, message: '请选择归属产品' }\n          ]\n        }]"}],attrs:{"show-search":"","filter-option":!1,placeholder:"请选择归属产品"},on:{popupScroll:e.productScroll,search:e.handleSearchProduct}},e._l(e.product.list,(function(t){return a("a-select-option",{key:t.id},[e._v("\n          "+e._s(t.title)+"\n        ")])})),1)],1),e._v(" "),a("a-form-item",{attrs:{label:"授课老师"}},[a("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["teacherId",{initialValue:e.teacher.initialValue,rules:[{required:!0,message:"请选择授课老师"}]}],expression:"['teacherId', {\n          initialValue: teacher.initialValue,\n          rules: [\n            { required: true, message: '请选择授课老师' }\n          ]\n        }]"}],attrs:{"show-search":"","filter-option":!1,placeholder:"请选择授课教师"},on:{popupScroll:e.teacherScroll,change:function(t){return e.handleChange(t,"teacher")},search:e.handleSearchTeacher}},e._l(e.teacher.list,(function(t){return a("a-select-option",{key:t.id,attrs:{disabled:t.disabled}},[e._v("\n          "+e._s(t.nickname)+"\n        ")])})),1)],1),e._v(" "),a("a-form-item",{attrs:{label:"助教"}},[a("a-select",{directives:[{name:"decorator",rawName:"v-decorator",value:["assistantIds",{initialValue:e.assistant.initialValue,rules:[{required:!0,message:"至少选择一位助教"},{validator:e.validatorAssistant}]}],expression:"['assistantIds', {\n          initialValue: assistant.initialValue,\n          rules: [\n            { required: true, message: '至少选择一位助教' },\n            { validator: validatorAssistant }\n          ]\n        }]"}],attrs:{"show-search":"","filter-option":!1,mode:"multiple",placeholder:"请选择助教"},on:{popupScroll:e.assistantScroll,search:e.handleSearchAssistant,blur:function(){return e.handleSearchAssistant("")},change:function(t){return e.handleChange(t,"assistant")}}},e._l(e.assistant.list,(function(t){return a("a-select-option",{key:t.id,attrs:{disabled:t.disabled}},[e._v("\n          "+e._s(t.nickname)+"\n        ")])})),1)],1),e._v(" "),a("a-form-item",{attrs:{label:"排课"}},[a("Schedule",{attrs:{"course-id":e.selectedCourseId,"course-set-id":e.selectedCourseSetId}})],1)],1),e._v(" "),a("div",{staticClass:"create-multi-class-btn-group"},[a("a-space",{attrs:{size:"large"}},[a("a-button",{attrs:{type:"primary",loading:e.ajaxLoading},on:{click:e.handleSubmit}},[e._v("\n        "+e._s("editor"===e.mode?"确定":"立即创建")+"\n      ")]),e._v(" "),a("a-button",{on:{click:e.clickCancelCreate}},[e._v("\n        取消\n      ")])],1)],1)],1)}),[],!1,null,null,null);t.default=p.exports}}]);